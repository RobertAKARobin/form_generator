<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Form Generator Proof-of-Concept</title>
		<style>
form{
	display:table;
	width:100%;
}
form .field{
	display:table-row;
}
form .field:hover > *{
	background-color:#eee;
}
form .label,
form .input{
	display:table-cell;
	width:50%;
	vertical-align:top;
	padding:20px 0 5px 0;
	border-bottom:1px solid #ccc;
}
label{
	cursor:pointer;
}
select[multiple]{
	width:100%;
}
		</style>
		<script src="//unpkg.com/mithril/mithril.min.js"></script>
		<script>
// Form data
const $ = {}

// Form component
class Form{

	constructor(){
		const form = this
		form.fields = []
	}

	oninit(){
		const form = this
		const search = location.search.substring(1);
		let urlParams = null
		try{
			urlParams = JSON.parse('{"' + decodeURI(search).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}')
		}catch(error){
			urlParams = {}
		}
		m.request('./fields.json').then((response)=>{
			form.fields = response
			for(let param in urlParams){
				$[param] = urlParams[param]
			}
		})
	}

	view(){
		const form = this
		let doStop = false
		return form.fields.map((field)=>{
			if(doStop && field.type != 'readonly' && !(field.code)){
				return false
			}else if(field.code){
				evalCode(field.code)
			}else{
				if(!(field.show_if) || !!(evalCode(field.show_if))){
					if(!($[field.field]) && field.type != 'readonly'){
						console.log(field.label)
						doStop = true
					}
					return m('label.field', [
						m('span.label', field.label),
						m('span.input', evalField(field))
					])
				}
			}
		})

		function evalCode(codeString){
			codeString = codeString.replace('\\n', '\n')
			try{
				return eval(codeString)
			}catch(error){
				console.log(`${error.message}: ${codeString}`)
				return false
			}
		}

		function evalField(field){
			if(field.type == 'select' || field.type == 'multiselect'){
				return m('select', {
					name: field.field,
					multiple: (field.type == 'multiselect' ? true : false),
					onchange: updateData
				}, [
					m('option', ' '),
					field.values.map((value)=>{
						return m('option', {
							value: value,
							selected: ($[field.field] === value)
						}, value)
					})
				])
			}else if(field.type == 'boolean'){
				return m('select', {
					name: field.field,
					onchange: updateData
				}, [
					m('option', ' '),
					m('option', {
						value: 'Yes',
						selected: ($[field.field] === 'Yes')
					}, 'Yes'),
					m('option', {
						value: 'No',
						selected: ($[field.field] === 'No')
					}, 'No')
				])
			}else if(field.type == 'readonly'){
				return m('span', $[field.field])
			}else{
				return m('input', {
					type: field.type,
					name: field.field,
					onchange: updateData,
					value: ($[field.field] || '')
				})
			}
		}

		function updateData(event){
			const input = event.target
			let value
			if(input.hasAttribute('multiple')){
				const options = Array.from(input.querySelectorAll('option'))
				value = options.filter(option => (option.selected && option.value)).map(option => option.value)
			}else{
				value = input.value
			}
			$[input.name] = value
		}
	}
}

window.addEventListener('DOMContentLoaded', ()=>{
	const form = new Form()
	m.mount(document.getElementById('form'), form)
})
		
		</script>
	</head>
	<body>
		<h1>Form Generator Proof-of-Concept</h1>

		<form id="form"></form>
	</body>
</html>
